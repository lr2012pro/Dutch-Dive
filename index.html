<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duik in het Nederlands</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase imports. These are automatically provided in the Canvas environment.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables from the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        
        // Global Firestore and Auth instances
        let app, db, auth;
        
        // Global status variables for the app
        let currentUserId = null;
        let isTeacher = false;
        let userLevel = 1;
        let userPoints = 0;
        let unsubscribeClassListener = null;

        // --- Core Application Functions ---

        /**
         * Initializes Firebase app and authentication.
         * Sets up the main authentication state listener.
         */
        const initializeAppAndAuth = async () => {
            setLogLevel('Debug');
            
            // Check for valid Firebase configuration before initializing
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase Initialization Error: Invalid or missing API Key in configuration.");
                showMessage("Fout: De app kan niet verbinden met de database. Controleer de configuratie.", () => {
                     // Optionally, hide loading screen to prevent app from being stuck
                    document.getElementById('loading-screen').classList.add('hidden');
                });
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await loadUserData();
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        document.getElementById('login-screen').classList.add('hidden');
                        updateUserProfileUI();
                        startFirestoreListeners();
                    } else {
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('login-screen').classList.remove('hidden');
                        document.getElementById('main-content').classList.add('hidden');
                        currentUserId = null;
                        if (unsubscribeClassListener) {
                            unsubscribeClassListener();
                        }
                    }
                });

                // Sign in with the provided custom token or anonymously as a fallback
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Fout bij het initialiseren van Firebase:", error);
                showMessage(`Fout bij het initialiseren van de app: ${error.message}`);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        };

        /**
         * Loads user data from Firestore on login.
         * If no data exists, creates a new user profile document.
         */
        const loadUserData = async () => {
            if (!currentUserId) return;
            const userDocRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/profile/data`);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const userData = userDoc.data();
                isTeacher = userData.isTeacher || false;
                userLevel = userData.level || 1;
                userPoints = userData.points || 0;
                updatePointsUI(userPoints);
                updateLevelUI(userLevel);
                updateProgressUI(userPoints);
            } else {
                await setDoc(userDocRef, { isTeacher: false, points: 0, level: 1, displayName: auth.currentUser.displayName || `Anonieme Gebruiker` });
                isTeacher = false;
                userPoints = 0;
                userLevel = 1;
                updatePointsUI(userPoints);
                updateLevelUI(userLevel);
                updateProgressUI(userPoints);
            }
        };

        /**
         * Updates user data in Firestore.
         * @param {object} data - The data to update.
         */
        const updateUserData = async (data) => {
            if (!currentUserId) return;
            const userDocRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userDocRef, data, { merge: true });
            } catch (error) {
                console.error("Fout bij het updaten van gebruikersgegevens:", error);
            }
        };

        /**
         * Starts real-time Firestore listeners based on user role.
         */
        const startFirestoreListeners = () => {
            if (isTeacher) {
                const classesColRef = collection(db, `/artifacts/${appId}/public/data/classes`);
                unsubscribeClassListener = onSnapshot(classesColRef, (snapshot) => {
                    const classes = [];
                    snapshot.forEach(doc => {
                        classes.push({ id: doc.id, ...doc.data() });
                    });
                    renderClasses(classes);
                });
            } else {
                const tasksColRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/tasks`);
                onSnapshot(tasksColRef, (snapshot) => {
                    const tasks = [];
                    snapshot.forEach(doc => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    renderStudentTasks(tasks);
                });
            }
        };

        // --- UI Rendering Functions ---

        /**
         * Renders a customizable modal dialog.
         * @param {string} message - The message to display.
         * @param {function} onOk - Callback function for the OK button.
         */
        const showMessage = (message, onOk = () => {}) => {
            const modalHtml = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
                    <div class="bg-blue-600 dark:bg-blue-900 bg-opacity-40 backdrop-blur-lg border border-white/20 p-8 rounded-2xl shadow-xl max-w-sm w-full text-center transform scale-95 transition-all">
                        <p class="text-lg font-semibold text-white mb-6">${message}</p>
                        <button id="close-modal" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition">OK</button>
                    </div>
                </div>
            `;
            const modal = document.createElement('div');
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal);
            document.getElementById('close-modal').addEventListener('click', () => {
                modal.remove();
                onOk();
            });
        };

        /**
         * Updates the user profile display in the header.
         */
        const updateUserProfileUI = () => {
            const displayName = auth.currentUser.displayName || `Anonieme Gebruiker`;
            const userId = auth.currentUser.uid;
            document.getElementById('user-profile-name').textContent = displayName;
            document.getElementById('user-id-display').textContent = `ID: ${userId}`;
            
            if (isTeacher) {
                document.getElementById('teacher-section').classList.remove('hidden');
                document.getElementById('student-only-content').classList.add('hidden');
                document.getElementById('teacher-section-btn').classList.remove('hidden');
            } else {
                document.getElementById('teacher-section').classList.add('hidden');
                document.getElementById('student-only-content').classList.remove('hidden');
                document.getElementById('teacher-section-btn').classList.add('hidden');
            }
        };

        /**
         * Updates the points display and checks for level up.
         * @param {number} amount - The amount of points to add or subtract.
         */
        const updatePoints = async (amount) => {
            userPoints += amount;
            updatePointsUI(userPoints);
            updateProgressUI(userPoints);
            const newLevel = getLevelFromPoints(userPoints);
            if (newLevel > userLevel) {
                userLevel = newLevel;
                updateLevelUI(userLevel);
                showMessage(`Gefeliciteerd! Je bent nu niveau ${userLevel}.`);
            }
            await updateUserData({ points: userPoints, level: userLevel });
        };

        /**
         * Updates the points display element.
         * @param {number} points - The current points total.
         */
        const updatePointsUI = (points) => {
            document.getElementById('points').textContent = points;
        };
        
        /**
         * Updates the level display element.
         * @param {number} level - The current level.
         */
        const updateLevelUI = (level) => {
            document.getElementById('level').textContent = level;
        };

        /**
         * Updates the progress bar based on current points.
         * @param {number} points - The current points total.
         */
        const updateProgressUI = (points) => {
            const nextLevelPoints = getNextLevelPoints(userLevel);
            const prevLevelPoints = getPreviousLevelPoints(userLevel);
            const pointsInLevel = points - prevLevelPoints;
            const levelGoal = nextLevelPoints - prevLevelPoints;
            const progress = (pointsInLevel / levelGoal) * 100;
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${Math.min(100, progress)}%`;
            document.getElementById('progress-text').textContent = `${pointsInLevel} / ${levelGoal} punten`;
        };

        // --- Helper Functions ---

        /**
         * Calculates the level based on points.
         * @param {number} points - The current points total.
         * @returns {number} The calculated level.
         */
        const getLevelFromPoints = (points) => {
            if (points < 100) return 1;
            if (points < 250) return 2;
            if (points < 500) return 3;
            return Math.floor(points / 250) + 1;
        };
        
        /**
         * Calculates the points needed for the next level.
         * @param {number} level - The current level.
         * @returns {number} The points goal for the next level.
         */
        const getNextLevelPoints = (level) => {
            if (level === 1) return 100;
            if (level === 2) return 250;
            return (level - 1) * 250;
        };

        /**
         * Calculates the points required to reach the current level.
         * @param {number} level - The current level.
         * @returns {number} The points at the start of the current level.
         */
        const getPreviousLevelPoints = (level) => {
            if (level <= 1) return 0;
            if (level === 2) return 100;
            if (level === 3) return 250;
            return (level - 2) * 250;
        };

        // --- Teacher UI Rendering Functions ---

        /**
         * Renders the list of classes for the teacher.
         * @param {Array} classes - An array of class objects.
         */
        const renderClasses = (classes) => {
            const classList = document.getElementById('class-list');
            classList.innerHTML = '';
            if (classes.length === 0) {
                classList.innerHTML = '<p class="text-white/70 text-center">Nog geen klassen aangemaakt.</p>';
            }
            classes.forEach((classObj) => {
                const listItem = document.createElement('li');
                listItem.textContent = classObj.name;
                listItem.className = 'glass-card p-4 cursor-pointer hover:bg-white/20 dark:hover:bg-black/20 transform hover:scale-105 transition-all text-center';
                listItem.dataset.id = classObj.id;
                classList.appendChild(listItem);
            });
        };

        /**
         * Displays the details of a specific class for the teacher.
         * @param {string} classId - The ID of the class to display.
         */
        const showClassDetails = async (classId) => {
            const classDocRef = doc(db, `/artifacts/${appId}/public/data/classes/${classId}`);
            onSnapshot(classDocRef, async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const classData = docSnapshot.data();
                    document.getElementById('current-class-id').textContent = classId;
                    document.getElementById('current-class-name').textContent = classData.name;
                    await renderStudentsInClass(classData.students);
                    renderTasksInClass(classData.tasks);
                    document.getElementById('teacher-class-management').classList.add('hidden');
                    document.getElementById('class-view').classList.remove('hidden');
                } else {
                    showMessage("Deze klas bestaat niet meer.");
                    document.getElementById('class-view').classList.add('hidden');
                    document.getElementById('teacher-class-management').classList.remove('hidden');
                }
            });
        };

        /**
         * Renders the list of students in a class with their points.
         * @param {Array} students - An array of student IDs.
         */
        const renderStudentsInClass = async (students) => {
            const studentList = document.getElementById('student-list');
            studentList.innerHTML = '';
            if (students.length === 0) {
                studentList.innerHTML = '<p class="text-white/70 text-center">Nog geen studenten in deze klas.</p>';
                return;
            }
            const studentDataPromises = students.map(async (studentId) => {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${studentId}/profile/data`);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    return { id: studentId, displayName: data.displayName, points: data.points || 0 };
                }
                return null;
            });
            const studentData = (await Promise.all(studentDataPromises)).filter(s => s !== null);
            
            // Sort students by points for the leaderboard
            studentData.sort((a, b) => b.points - a.points);

            studentData.forEach(student => {
                const listItem = document.createElement('li');
                listItem.className = 'glass-card p-4 flex justify-between items-center transform hover:scale-105 transition-transform';
                listItem.innerHTML = `
                    <div class="flex-grow">
                        <span>${student.displayName}</span>
                        <span class="text-sm text-yellow-300 ml-2">(${student.points} punten)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="view-student-btn bg-blue-500 text-white px-3 py-1 rounded-full text-sm hover:bg-blue-600 transition" data-student-id="${student.id}">Bekijk</button>
                        <button class="remove-student-btn bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition" data-student-id="${student.id}">Verwijder</button>
                    </div>
                `;
                studentList.appendChild(listItem);
            });
        };
        
        /**
         * Renders the list of tasks for the teacher to manage.
         * @param {Array} tasks - An array of task objects.
         */
        const renderTasksInClass = (tasks) => {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            if (tasks.length === 0) {
                taskList.innerHTML = '<p class="text-white/70 text-center">Geen taken in deze klas.</p>';
            }
            tasks.forEach((task, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'glass-card p-4 flex justify-between items-center transform hover:scale-105 transition-transform';
                listItem.innerHTML = `
                    <div class="flex-grow">
                        <span>${task.text}</span>
                        <span class="text-sm text-yellow-300 ml-2">(${task.points} punten)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="edit-task-btn bg-yellow-500 text-white px-3 py-1 rounded-full text-sm hover:bg-yellow-600 transition" data-task-index="${index}">Bewerk</button>
                        <button class="remove-task-btn bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition" data-task-index="${index}">Verwijder</button>
                    </div>
                `;
                taskList.appendChild(listItem);
            });
        };

        /**
         * Renders a modal with a student's progress details.
         * @param {string} studentId - The ID of the student.
         */
        const showStudentDetails = async (studentId) => {
            const studentDocRef = doc(db, `/artifacts/${appId}/users/${studentId}/profile/data`);
            const studentDoc = await getDoc(studentDocRef);
            if (!studentDoc.exists()) {
                showMessage("Studentprofiel niet gevonden.");
                return;
            }
            const studentData = studentDoc.data();
            const studentTasksColRef = collection(db, `/artifacts/${appId}/users/${studentId}/tasks`);
            const q = query(studentTasksColRef);
            const querySnapshot = await getDocs(q);
            const tasks = [];
            querySnapshot.forEach(doc => {
                tasks.push(doc.data());
            });

            const completedTasks = tasks.filter(t => t.completed).length;
            const totalTasks = tasks.length;
            const tasksHtml = tasks.map(task => `<li class="p-2 border-b border-gray-700 last:border-b-0">${task.text} - ${task.completed ? 'Voltooid' : 'Niet voltooid'}</li>`).join('');

            const modalHtml = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
                    <div class="bg-blue-600 dark:bg-blue-900 bg-opacity-40 backdrop-blur-lg border border-white/20 p-8 rounded-2xl shadow-xl max-w-lg w-full transform scale-95 transition-all">
                        <h3 class="text-xl font-bold mb-4">Voortgang van ${studentData.displayName}</h3>
                        <p class="mb-2">Punten: <span class="font-bold text-yellow-300">${studentData.points || 0}</span></p>
                        <p class="mb-4">Niveau: <span class="font-bold text-green-300">${studentData.level || 1}</span></p>
                        <h4 class="font-semibold mt-4 mb-2">Toegewezen taken (${completedTasks}/${totalTasks})</h4>
                        <ul class="max-h-60 overflow-y-auto">
                            ${tasksHtml || '<li>Geen taken toegewezen.</li>'}
                        </ul>
                        <button id="close-student-modal" class="mt-6 bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition">Sluit</button>
                    </div>
                </div>
            `;
            const modal = document.createElement('div');
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal);
            document.getElementById('close-student-modal').addEventListener('click', () => {
                modal.remove();
            });
        };

        // --- Student UI Rendering Functions ---

        /**
         * Renders the list of tasks for the student.
         * @param {Array} tasks - An array of task objects.
         */
        const renderStudentTasks = (tasks) => {
            const taskList = document.getElementById('student-task-list');
            taskList.innerHTML = '';
            if (tasks.length === 0) {
                taskList.innerHTML = '<p class="text-white/70 text-center">Geen taken toegewezen of aangemaakt.</p>';
            } else {
                tasks.forEach(task => {
                    const listItem = createTaskElement(task);
                    taskList.appendChild(listItem);
                });
            }
        };
        
        /**
         * Creates a single task list item element.
         * @param {object} task - The task object.
         * @returns {HTMLElement} The created list item element.
         */
        const createTaskElement = (task) => {
            const listItem = document.createElement('li');
            listItem.className = `glass-card p-4 flex justify-between items-center ${task.completed ? 'opacity-50' : ''} transform hover:scale-105 transition-transform`;
            listItem.innerHTML = `
                <span>${task.text} (+${task.points} punten)</span>
                <input type="checkbox" class="task-checkbox h-5 w-5 rounded-md text-green-500 focus:ring-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
            `;
            return listItem;
        };
        
        // --- Quiz Component ---

        const quizQuestions = [
            { question: "Wat is het meervoud van 'stad'?", answer: "steden", points: 25 },
            { question: "Wat is een synoniem voor 'leuk'?", answer: "gezellig", points: 25 },
            { question: "Welk woord is een zelfstandig naamwoord: 'rennen', 'mooi' of 'huis'?", answer: "huis", points: 25 },
            { question: "Vul in: 'Ik heb **het** boek gelezen.'", answer: "het", points: 25 },
            { question: "Wat is de verleden tijd van 'lopen'?", answer: "liep", points: 25 }
        ];

        let currentQuestionIndex = 0;
        let quizTimer;

        /**
         * Initializes and starts the quiz.
         */
        const startQuiz = () => {
            document.getElementById('quiz-intro').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            currentQuestionIndex = 0;
            renderQuizQuestion();
        };

        /**
         * Renders the current quiz question and starts the timer.
         */
        const renderQuizQuestion = () => {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }
            const questionData = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-question').textContent = questionData.question;
            document.getElementById('quiz-answer-input').value = '';
            document.getElementById('quiz-feedback').textContent = '';
            document.getElementById('quiz-timer').textContent = 15;
            
            clearInterval(quizTimer);
            let timeLeft = 15;
            quizTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('quiz-timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    checkQuizAnswer(true); // Times up
                }
            }, 1000);
        };

        /**
         * Checks the user's quiz answer.
         * @param {boolean} timesUp - True if the timer ran out.
         */
        const checkQuizAnswer = (timesUp = false) => {
            clearInterval(quizTimer);
            const userAnswer = document.getElementById('quiz-answer-input').value.trim().toLowerCase();
            const correctAnswer = quizQuestions[currentQuestionIndex].answer.toLowerCase();
            const feedbackEl = document.getElementById('quiz-feedback');
            
            if (timesUp) {
                feedbackEl.textContent = `Tijd is op! Het juiste antwoord was "${correctAnswer}".`;
            } else if (userAnswer === correctAnswer) {
                feedbackEl.textContent = `Juist! Goed gedaan. (+${quizQuestions[currentQuestionIndex].points} punten)`;
                updatePoints(quizQuestions[currentQuestionIndex].points);
            } else {
                feedbackEl.textContent = `Onjuist. Het juiste antwoord was "${correctAnswer}".`;
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                renderQuizQuestion();
            }, 2000);
        };

        /**
         * Ends the quiz and returns to the main tasks view.
         */
        const endQuiz = () => {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-intro').classList.remove('hidden');
            showMessage("Quiz voltooid! Je kunt je nieuwe punten zien op je profiel.");
        };

        // --- Event Handlers ---

        document.addEventListener('DOMContentLoaded', async () => {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const switchFormBtn = document.getElementById('switch-form-btn');
            const logoutBtn = document.getElementById('logout-btn');
            
            // Remove the old login forms as they are not needed with the new auth flow
            loginForm.classList.add('hidden');
            signupForm.classList.add('hidden');
            switchFormBtn.classList.add('hidden');

            const handleLogin = async (name, password) => {
                // This function is now obsolete with the new auth flow
                // The onAuthStateChanged listener handles login automatically
            };
            
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage("U bent uitgelogd.");
                } catch (error) {
                    console.error("Fout bij uitloggen:", error);
                }
            });

            initializeAppAndAuth();
        
            const themeToggleBtn = document.getElementById('theme-toggle');
            const body = document.body;

            themeToggleBtn.addEventListener('click', () => {
                body.classList.toggle('dark');
            });

            const navButtons = document.querySelectorAll('.nav-btn');
            const contentSections = document.querySelectorAll('.content-section');
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.dataset.target;
                    contentSections.forEach(section => {
                        if (section.id === target) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    });
                });
            });

            const createClassBtn = document.getElementById('create-class-btn');
            createClassBtn.addEventListener('click', async () => {
                const className = document.getElementById('class-name-input').value.trim();
                if (className) {
                    const classesColRef = collection(db, `/artifacts/${appId}/public/data/classes`);
                    await addDoc(classesColRef, { name: className, createdBy: currentUserId, students: [], tasks: [] });
                    document.getElementById('class-name-input').value = '';
                }
            });

            const classList = document.getElementById('class-list');
            classList.addEventListener('click', async (event) => {
                const target = event.target;
                if (target.matches('li')) {
                    const classId = target.dataset.id;
                    await showClassDetails(classId);
                }
            });

            const classView = document.getElementById('class-view');
            classView.addEventListener('click', async (event) => {
                const target = event.target;
                const classId = document.getElementById('current-class-id').textContent;
                const classDocRef = doc(db, `/artifacts/${appId}/public/data/classes/${classId}`);

                if (target.classList.contains('remove-student-btn')) {
                    const studentIdToRemove = target.dataset.studentId;
                    const classDoc = await getDoc(classDocRef);
                    const students = classDoc.data().students.filter(id => id !== studentIdToRemove);
                    await setDoc(classDocRef, { students }, { merge: true });
                } else if (target.classList.contains('remove-task-btn')) {
                    const taskIndex = parseInt(target.dataset.taskIndex);
                    const classDoc = await getDoc(classDocRef);
                    const tasks = classDoc.data().tasks;
                    const removedTask = tasks[taskIndex];
                    tasks.splice(taskIndex, 1);
                    await setDoc(classDocRef, { tasks }, { merge: true });

                    const studentsInClass = classDoc.data().students || [];
                    for (const studentId of studentsInClass) {
                        const studentTasksColRef = collection(db, `/artifacts/${appId}/users/${studentId}/tasks`);
                        const q = query(studentTasksColRef);
                        const querySnapshot = await getDocs(q);
                        querySnapshot.forEach(async (doc) => {
                            if (doc.data().text === removedTask.text && doc.data().points === removedTask.points) {
                                await deleteDoc(doc.ref);
                            }
                        });
                    }
                } else if (target.classList.contains('view-student-btn')) {
                    const studentIdToView = target.dataset.studentId;
                    showStudentDetails(studentIdToView);
                }
            });
            
            const addTaskToClassBtn = document.getElementById('add-task-to-class-btn');
            addTaskToClassBtn.addEventListener('click', async () => {
                const taskText = document.getElementById('task-text-input').value.trim();
                const taskPoints = parseInt(document.getElementById('task-points-input').value);
                const classId = document.getElementById('current-class-id').textContent;
                
                if (taskText && !isNaN(taskPoints) && classId) {
                    try {
                        const classDocRef = doc(db, `/artifacts/${appId}/public/data/classes/${classId}`);
                        const classDoc = await getDoc(classDocRef);
                        const tasks = classDoc.data().tasks || [];
                        const students = classDoc.data().students || [];
                        
                        const newTask = { text: taskText, points: taskPoints };
                        await setDoc(classDocRef, { tasks: [...tasks, newTask] }, { merge: true });

                        for (const studentId of students) {
                            const studentTasksColRef = collection(db, `/artifacts/${appId}/users/${studentId}/tasks`);
                            await addDoc(studentTasksColRef, {
                                text: newTask.text,
                                points: newTask.points,
                                completed: false
                            });
                        }

                        showMessage("Taak succesvol toegevoegd!");
                        document.getElementById('task-text-input').value = '';
                        document.getElementById('task-points-input').value = '';
                    } catch (error) {
                        showMessage(`Fout bij het toevoegen van taak: ${error.message}`);
                    }
                }
            });

            const returnToClassesBtn = document.getElementById('return-to-classes-btn');
            returnToClassesBtn.addEventListener('click', () => {
                document.getElementById('class-view').classList.add('hidden');
                document.getElementById('teacher-class-management').classList.remove('hidden');
            });

            const studentTaskList = document.getElementById('student-task-list');
            studentTaskList.addEventListener('change', async (event) => {
                const target = event.target;
                if (target.classList.contains('task-checkbox')) {
                    const taskId = target.dataset.taskId;
                    const isCompleted = target.checked;
                    const taskDocRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/tasks/${taskId}`);
                    const taskDoc = await getDoc(taskDocRef);
                    if (taskDoc.exists()) {
                        const taskData = taskDoc.data();
                        await setDoc(taskDocRef, { completed: isCompleted }, { merge: true });
                        if (isCompleted) {
                            await updatePoints(taskData.points);
                        } else {
                            await updatePoints(-taskData.points);
                        }
                    }
                }
            });

            const joinClassBtn = document.getElementById('join-class-btn');
            joinClassBtn.addEventListener('click', async () => {
                const classId = document.getElementById('join-class-input').value.trim();
                if (classId) {
                    try {
                        const classDocRef = doc(db, `/artifacts/${appId}/public/data/classes/${classId}`);
                        const classDoc = await getDoc(classDocRef);
                        if (!classDoc.exists()) {
                            showMessage("Klas met deze ID bestaat niet.");
                            return;
                        }

                        const classData = classDoc.data();
                        const students = classData.students || [];
                        if (students.includes(currentUserId)) {
                            showMessage("Je zit al in deze klas.");
                            return;
                        }

                        await setDoc(classDocRef, { students: [...students, currentUserId] }, { merge: true });
                        
                        const tasks = classData.tasks || [];
                        const studentTasksColRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/tasks`);
                        for (const task of tasks) {
                            await addDoc(studentTasksColRef, {
                                text: task.text,
                                points: task.points,
                                completed: false
                            });
                        }
                        showMessage("Je bent succesvol lid geworden van de klas!");
                        document.getElementById('join-class-input').value = '';
                    } catch (error) {
                        showMessage(`Fout bij het lid worden van de klas: ${error.message}`);
                    }
                }
            });

            const createStudentTaskBtn = document.getElementById('create-student-task-btn');
            createStudentTaskBtn.addEventListener('click', async () => {
                const taskText = document.getElementById('create-task-text-input').value.trim();
                const taskPoints = parseInt(document.getElementById('create-task-points-input').value);
                
                if (taskText && !isNaN(taskPoints)) {
                    try {
                        const studentTasksColRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/tasks`);
                        await addDoc(studentTasksColRef, {
                            text: taskText,
                            points: taskPoints,
                            completed: false
                        });
                        showMessage("Taak succesvol aangemaakt!");
                        document.getElementById('create-task-text-input').value = '';
                        document.getElementById('create-task-points-input').value = '';
                    } catch (error) {
                        showMessage(`Fout bij het aanmaken van de taak: ${error.message}`);
                    }
                }
            });

            // Quiz Event Listeners
            const quizStartBtn = document.getElementById('start-quiz-btn');
            const quizSubmitBtn = document.getElementById('quiz-submit-btn');
            const quizAnswerInput = document.getElementById('quiz-answer-input');

            if (quizStartBtn) {
                quizStartBtn.addEventListener('click', startQuiz);
            }
            if (quizSubmitBtn) {
                quizSubmitBtn.addEventListener('click', () => checkQuizAnswer());
            }
            if (quizAnswerInput) {
                quizAnswerInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        checkQuizAnswer();
                    }
                });
            }
        });

    </script>
    <style>
        /* General Styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e3a8a, #0f172a);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .dark body {
            background: linear-gradient(135deg, #000000, #1a202c, #000000);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }

        .dark .glass-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        input[type="text"], input[type="password"], input[type="number"], select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            outline: none;
            transition: all 0.2s ease-in-out;
        }
        
        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #8b5cf6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7c3aed;
        }

        .btn-success {
            background-color: #22c55e;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #16a34a;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-info {
            background-color: #f59e0b;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #d97706;
        }

        .progress-bar-container {
            height: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #22d3ee, #3b82f6);
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }

    </style>
</head>
<body class="bg-gray-900 dark:bg-gray-900 text-white flex flex-col p-4">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-70 z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md p-8 glass-card">
            <h1 class="text-3xl font-bold text-center mb-6">Welkom bij Duik in het Nederlands</h1>
            <h2 class="text-xl font-semibold text-center">Inloggen</h2>
            <p class="text-white/70 text-sm text-center">U wordt automatisch ingelogd als anonieme gebruiker. Uw voortgang wordt opgeslagen.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden w-full max-w-4xl mx-auto space-y-6 pb-8">
        <header class="flex flex-col md:flex-row items-center justify-between p-4 glass-card">
            <h1 class="text-2xl md:text-3xl font-bold">Duik in het Nederlands</h1>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div class="flex flex-col items-end">
                    <span id="user-profile-name" class="font-semibold"></span>
                    <span id="user-id-display" class="text-sm text-white/70"></span>
                </div>
                <div class="relative">
                    <button id="logout-btn" class="btn btn-danger">Uitloggen</button>
                </div>
            </div>
        </header>

        <nav class="flex justify-center md:justify-start space-x-2 md:space-x-4 p-2 glass-card">
            <button class="nav-btn btn btn-primary" data-target="tasks-section">Taken & Voortgang</button>
            <button class="nav-btn btn btn-info" data-target="quiz-section">Quizzen</button>
            <button id="teacher-section-btn" class="nav-btn btn btn-secondary hidden" data-target="teacher-section">Docent</button>
        </nav>

        <!-- Tasks and Progress Section (Student) -->
        <div id="tasks-section" class="content-section space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- My Profile and Progress Card -->
                <div class="p-6 glass-card">
                    <h2 class="text-xl font-semibold mb-4">Mijn Profiel</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <p class="font-bold">Punten:</p>
                            <span id="points" class="text-xl text-yellow-300 font-bold">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="font-bold">Niveau:</p>
                            <span id="level" class="text-xl text-green-300 font-bold">1</span>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Voortgang naar volgend niveau:</p>
                            <div class="relative progress-bar-container">
                                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                                <span id="progress-text" class="absolute inset-0 flex items-center justify-center text-sm font-semibold">0 / 100 punten</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Tasks and Class Management Card -->
                <div id="student-only-content" class="p-6 glass-card">
                    <h2 class="text-xl font-semibold mb-4">Taken</h2>
                    
                    <div class="space-y-2 mb-4">
                        <h3 class="font-semibold">Maak een eigen taak</h3>
                        <input type="text" id="create-task-text-input" placeholder="Taakomschrijving" class="w-full p-2 rounded-lg text-black">
                        <input type="number" id="create-task-points-input" placeholder="Aantal punten" class="w-full p-2 rounded-lg text-black">
                        <button id="create-student-task-btn" class="w-full btn btn-success">Voeg taak toe</button>
                    </div>

                    <div class="flex items-center space-x-2 mb-4">
                        <input type="text" id="join-class-input" placeholder="Word lid van een klas (ID)" class="w-full p-2 rounded-lg text-black">
                        <button id="join-class-btn" class="btn btn-info px-4 py-2">Word lid</button>
                    </div>

                    <ul id="student-task-list" class="space-y-4">
                        <!-- Tasks will be loaded here dynamically -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Quiz Section (Student) -->
        <div id="quiz-section" class="content-section hidden space-y-6">
            <div id="quiz-intro" class="p-6 glass-card text-center">
                <h2 class="text-2xl font-semibold mb-4">Test je kennis!</h2>
                <p class="mb-6">Doe een quiz om extra punten te verdienen. Elke quiz bestaat uit 5 vragen.</p>
                <button id="start-quiz-btn" class="btn btn-primary">Start de quiz</button>
            </div>

            <div id="quiz-container" class="p-6 glass-card hidden space-y-4">
                <h2 class="text-2xl font-semibold text-center mb-4">Quiz</h2>
                <div class="text-lg font-bold">
                    <p>Vraag <span id="current-question-number">1</span>/5</p>
                    <p id="quiz-question"></p>
                </div>
                <div class="flex items-center justify-between text-lg">
                    <p>Tijd over: <span id="quiz-timer" class="font-bold text-yellow-300">15</span>s</p>
                    <p id="quiz-feedback" class="font-semibold"></p>
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="quiz-answer-input" placeholder="Jouw antwoord" class="flex-grow p-3 rounded-xl text-black">
                    <button id="quiz-submit-btn" class="btn btn-success">Verstuur</button>
                </div>
            </div>
        </div>


        <!-- Teacher Section -->
        <div id="teacher-section" class="content-section hidden space-y-6">
            <div id="teacher-class-management" class="p-6 glass-card">
                <h2 class="text-xl font-semibold mb-4">Mijn Klassen</h2>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="class-name-input" placeholder="Nieuwe klasnaam" class="w-full p-2 rounded-lg text-black">
                    <button id="create-class-btn" class="btn btn-primary">Maak aan</button>
                </div>
                <ul id="class-list" class="space-y-4">
                    <!-- Classes will be loaded here dynamically -->
                </ul>
            </div>

            <div id="class-view" class="hidden p-6 glass-card">
                <button id="return-to-classes-btn" class="btn btn-secondary mb-4">Terug naar klassen</button>
                <h2 class="text-xl font-semibold mb-2">Klas: <span id="current-class-name" class="font-bold"></span></h2>
                <p class="text-sm text-white/70 mb-4">Klas-ID: <span id="current-class-id" class="font-mono text-xs break-all"></span></p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Student Management Card -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Studenten & Ranglijst</h3>
                        <div class="flex space-x-2 mb-4">
                            <input type="text" id="student-id-input" placeholder="Student ID" class="w-full p-2 rounded-lg text-black">
                            <button id="add-student-to-class-btn" class="btn btn-primary px-4 py-2">Voeg toe</button>
                        </div>
                        <ul id="student-list" class="space-y-4">
                            <!-- Students will be loaded here dynamically -->
                        </ul>
                    </div>

                    <!-- Task Management Card -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Taken</h3>
                        <div class="space-y-2 mb-4">
                            <input type="text" id="task-text-input" placeholder="Nieuwe taakbeschrijving" class="w-full p-2 rounded-lg text-black">
                            <input type="number" id="task-points-input" placeholder="Punten" class="w-full p-2 rounded-lg text-black">
                            <button id="add-task-to-class-btn" class="w-full btn btn-success">Voeg taak toe</button>
                        </div>
                        <ul id="task-list" class="space-y-4">
                            <!-- Tasks will be loaded here dynamically -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
